import websocket
import json
import requests

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨ÙˆØª ØªÙ„Ø¬Ø±Ø§Ù…
TELEGRAM_TOKEN = 'YOUR_TELEGRAM_TOKEN'
CHAT_ID = 'YOUR_CHAT_ID'

def send_telegram_message(message):
    url = f'https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage'
    payload = {
        'chat_id': CHAT_ID,
        'text': message,
        'parse_mode': 'Markdown'
    }
    requests.post(url, json=payload)

# ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„ÙƒÙ„ Ø¹Ù…Ù„Ø©
old_prices = {}

def get_liquidity(symbol):
    """Ø¬Ù„Ø¨ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ù„Ù„Ø¹Ù…Ù„Ø©"""
    url = f'https://api.binance.com/api/v3/ticker/bookTicker?symbol={symbol}'
    response = requests.get(url)
    if response.status_code == 200:
        data = response.json()
        return data.get('bidQty', 'N/A')  # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙ…ÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± (bid quantity) ÙƒØ³ÙŠÙˆÙ„Ø©
    return 'N/A'

def on_message(ws, message):
    try:
        print(f"Received message: {message}")  # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©
        item = json.loads(message)  # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        symbol = item['s']  # Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø©
        new_price = float(item['p'])  # Ø³Ø¹Ø± Ø§Ù„ØµÙÙ‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ

        if symbol not in old_prices:
            old_prices[symbol] = new_price  # ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø¹Ø± ÙƒÙ€ Ø³Ø¹Ø± Ù‚Ø¯ÙŠÙ…
            return  # Ù„Ø§ Ù†Ù‚ÙˆÙ… Ø¨Ø£ÙŠ Ø´ÙŠØ¡ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰

        old_price = old_prices[symbol]
        change_percentage = ((new_price - old_price) / old_price) * 100

        # ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ù…ÙˆØ² Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
        alert_symbol = ''
        if change_percentage >= 10:
            alert_symbol = 'â«'
        elif change_percentage >= 6:
            alert_symbol = 'â“‚ï¸'
        elif change_percentage >= 5:
            alert_symbol = 'ðŸš¨'
        elif change_percentage >= 4:
            alert_symbol = 'ðŸŸ£'
        elif change_percentage >= 3:
            alert_symbol = 'ðŸ’¥'
        elif change_percentage >= 2:
            alert_symbol = 'ðŸŸ¢'
        elif change_percentage >= 1:
            alert_symbol = 'ðŸŸ¡'
        
        # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø±Ø§Ø­Ù„
        stage_count = 0
        if change_percentage >= 1:
            stage_count = min(3, int((change_percentage - 1) // 0.2))

        # Ø¬Ù„Ø¨ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ù„Ù„Ø¹Ù…Ù„Ø©
        liquidity = get_liquidity(symbol)

        if stage_count > 0 or alert_symbol:  # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø­Ø±ÙƒØ©
            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            message_template = f"-  #{symbol} ({stage_count + 1}) {alert_symbol * (stage_count + 1)} - 24h\n"
            message_template += "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n"
            message_template += f"- ðŸ’° Old Price: {old_price:.6f}\n"
            message_template += f"- ðŸ’° New Price: {new_price:.6f}\n"
            message_template += f"- ðŸ”„ Change: {change_percentage:.2f}%\n"
            message_template += f"- ðŸ’± Liquidity : {liquidity}\n"
            
            if change_percentage >= 1:  # ØªØ®ØµÙŠØµ Ø§Ù„Ø´Ø±Ø· Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
                message_template += "-  PUMP DETECT\n"

            print(message_template)
            send_telegram_message(message_template)  # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ù„Ù‰ ØªÙ„Ø¬Ø±Ø§Ù…

        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…
        old_prices[symbol] = new_price
    except Exception as e:
        print(f"Error parsing message: {e}")

def on_error(ws, error):
    print(f"Error: {error}")

def on_close(ws, close_status_code, close_msg):
    print("Connection closed")

def on_open(ws):
    print("Connection opened")

def start_websocket(symbol):
    websocket_url = f"wss://stream.binance.com:9443/ws/{symbol}@trade"
    ws = websocket.WebSocketApp(websocket_url,
                                on_message=on_message,
                                on_error=on_error,
                                on_close=on_close)
    ws.on_open = on_open
    ws.run_forever()

def main():
    # Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ù…ØªØ§Ø­Ø©
    response = requests.get('https://api.binance.com/api/v3/exchangeInfo')
    if response.status_code == 200:
        symbols = response.json()['symbols']
        for symbol_info in symbols:
            symbol = symbol_info['symbol']
            # Ø¨Ø¯Ø¡ WebSocket Ù„ÙƒÙ„ Ø²ÙˆØ¬ Ø¹Ù…Ù„Ø©
            start_websocket(symbol)  # Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„ÙƒÙ„ Ø²ÙˆØ¬ Ø¹Ù…Ù„Ø©

if __name__ == "__main__":
    main()
